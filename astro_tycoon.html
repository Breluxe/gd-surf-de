<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Astro Tycoon</title>
<style>
  :root{
    --bg:#0b1020;
    --card:#121a33cc;
    --card-strong:#1a2548dd;
    --text:#e8eeff;
    --muted:#a9b3d6;
    --accent:#6cf3ff;
    --accent-2:#8a7dff;
    --good:#6cffc3;
    --warn:#ffd36c;
    --bad:#ff6c9c;
    --glow: 0 0 18px rgba(108,243,255,.35);
    --radius:18px;
  }
  * { box-sizing: border-box }
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background: radial-gradient(1200px 700px at 20% -10%, #192a5c77 0%, transparent 50%) no-repeat,
                radial-gradient(900px 600px at 120% 10%, #2a145c77 0%, transparent 55%) no-repeat,
                radial-gradient(700px 700px at -10% 120%, #0d5a6b55 0%, transparent 60%) no-repeat,
                var(--bg);
    overflow: hidden;
    animation: bgMove 12s linear infinite alternate;
  }

  @keyframes bgMove {
    0% { background-position: 0% 0%, 100% 0%, 0% 100%, 0% 0%; }
    100% { background-position: 10% 10%, 90% 10%, 10% 90%, 0% 0%; }
  }

  .app {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes fadeInApp {
    from { opacity: 0; transform: scale(0.97);}
    to { opacity: 1; transform: scale(1);}
  }
  header {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes headerPop {
    from { opacity: 0; transform: translateY(-30px);}
    to { opacity: 1; transform: translateY(0);}
  }
  .title {
    animation: titlePulse 2s infinite alternate;
  }
  @keyframes titlePulse {
    0% { filter: drop-shadow(0 0 0px #6cf3ff); }
    100% { filter: drop-shadow(0 0 12px #6cf3ff); }
  }
  .pill {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes pillPop {
    from { opacity: 0; transform: scale(0.8);}
    to { opacity: 1; transform: scale(1);}
  }
  .btn {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes btnFadeIn {
    from { opacity: 0; transform: scale(0.9);}
    to { opacity: 1; transform: scale(1);}
  }
  .btn.secondary {
    background: linear-gradient(90deg, #ffd36c 0%, #8a7dff 100%);
    color:#1a2548;
  }
  .mega-button {
    background: linear-gradient(90deg, #ffd36c 0%, #6cf3ff 100%);
    color:#0b1020;
    box-shadow: 0 10px 40px #ffd36c55;
    animation: megaBtnPulse 2s infinite alternate;
  }
  @keyframes megaBtnPulse {
    0% { box-shadow: 0 10px 40px #ffd36c55; }
    100% { box-shadow: 0 10px 60px #6cf3ff99; }
  }
  .tabs {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes fadeInTabs {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .tab.active {
    background:linear-gradient(90deg,#ffd36c 0%, #8a7dff 100%);
    color:#0b1020;
  }
  .card {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes cardFadeIn {
    from { opacity: 0; transform: translateY(30px);}
    to { opacity: 1; transform: translateY(0);}
  }
  .card h2 {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes fadeInTitle {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .item {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes itemFadeIn {
    from { opacity: 0; transform: scale(0.95);}
    to { opacity: 1; transform: scale(1);}
  }
  .buy {
    background: linear-gradient(90deg, #ffd36c 0%, #8a7dff 100%);
    color:#0b1020;
    transition: background 0.2s;
  }
  .buy:active {
    background: linear-gradient(90deg, #8a7dff 0%, #ffd36c 100%);
  }
  .kicker {
    animation: kickerPulse 2s infinite alternate;
  }
  @keyframes kickerPulse {
    0% { color: var(--good);}
    100% { color: var(--accent);}
  }
  .achv {
    /* Animation nur beim initialen Laden, nicht bei jedem Render */
  }
  @keyframes achvFadeIn {
    from { opacity: 0; transform: scale(0.95);}
    to { opacity: 1; transform: scale(1);}
  }
  /* Starfield background canvas */
  #space{
    position: fixed;
    inset:0;
    z-index:0;
    filter: blur(0.3px) brightness(0.9);
    opacity: .6;
    pointer-events:none;
  }
  .app{
    position:relative;
    z-index:1;
    display:flex;
    flex-direction:column;
    height:100%;
    gap:14px;
    padding:16px;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    background: linear-gradient(180deg, #1b2445cc, #111a33cc);
    box-shadow: 0 8px 30px rgba(0,0,0,.3), var(--glow);
    border: 1px solid #2b3b77;
    border-radius: var(--radius);
  }
  .title{
    display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.4px;
  }
  .title .badge{ font-size:12px; color:var(--muted)}
  .title h1{font-size:20px; margin:0}
  .totals{
    display:flex; gap:18px; flex-wrap:wrap; align-items:center
  }
  .pill{
    padding:8px 12px;
    background: linear-gradient(180deg, #1e2a57, #12203f);
    border:1px solid #2a3e88;
    border-radius: 999px;
    box-shadow: var(--glow);
    font-weight:600;
  }
  .pill small{ display:block; font-size:11px; color:var(--muted); font-weight:500 }
  .controls{
    display:flex; gap:8px; flex-wrap:wrap
  }
  .btn{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #3951a6;
    background: linear-gradient(180deg, #2b3fa0, #1b2a66);
    color:white; font-weight:700; letter-spacing:.3px;
    box-shadow: var(--glow);
    cursor:pointer;
    transition: transform .08s ease, filter .2s ease, opacity .2s;
    user-select:none;
  }
  .btn.secondary{
    background: linear-gradient(180deg, #213062, #172246);
    border-color:#304286;
    font-weight:600;
  }
  .btn:disabled{opacity:.5; cursor:not-allowed; filter:grayscale(.3)}
  .btn:active{ transform: translateY(1px) scale(.99) }
  main{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:14px;
    min-height: 0; /* allow children to shrink */
  }
  @media (max-width: 1000px){
    main{ grid-template-columns: 1fr }
    .sidebar{ order:2 }
  }
  .card{
    background: linear-gradient(180deg, var(--card), #0c1430cc);
    border:1px solid #263a7a;
    border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    overflow:hidden;
    min-height:0;
  }
  .card h2{
    margin:0; padding:14px 16px;
    border-bottom:1px solid #253872;
    background: linear-gradient(180deg, #1b2445bb, #121a33cc);
    font-size:16px; letter-spacing:.3px;
  }
  .sidebar{
    display:flex; flex-direction:column; gap:14px; min-height:0;
  }
  .panel{
    padding:14px;
    display:flex; flex-direction:column; gap:12px;
    min-height:0;
  }
  .clicker{
    display:flex; flex-direction:column; gap:10px; align-items:stretch; text-align:center;
  }
  .mega-button{
    padding:20px;
    font-size:20px;
    border-radius:18px;
    background: linear-gradient(180deg, #5ad2ff, #8a7dff);
    color:#0b1020;
    font-weight:900;
    border: none;
    cursor:pointer;
    box-shadow: 0 10px 40px rgba(108,243,255,.45);
    transition: transform .08s ease, filter .2s ease;
  }
  .mega-button:active{ transform: translateY(2px) scale(.995) }
  .rate{ color:var(--muted); font-size:14px}
  .tabs{
    display:flex; gap:6px; padding:8px; flex-wrap:wrap;
    background: linear-gradient(180deg, #111a33cc, #0c1430cc);
    border-bottom:1px solid #22356b;
  }
  .tab{ padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none; font-weight:700; border:1px solid transparent}
  .tab.active{ background:#233168; border-color:#3a52a6; box-shadow: var(--glow) }
  .content{ padding:14px; min-height: 0; overflow:auto; scrollbar-width: thin}
  .grid{
    display:grid; gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  }
  .item{
    background: linear-gradient(180deg, var(--card-strong), #0e1734cc);
    border: 1px solid #2b3f84;
    border-radius:16px; padding:12px;
    display:flex; flex-direction:column; gap:8px;
    position:relative;
  }
  .item h3{ margin:0; font-size:16px }
  .item .desc{ color:var(--muted); font-size:13px }
  .item .row{ display:flex; justify-content:space-between; align-items:center }
  .price{ font-weight:800 }
  .level{ font-size:12px; color:var(--muted) }
  .buy{ padding:8px 10px; font-weight:800; border-radius:10px; border:1px solid #3a54bb; background: linear-gradient(180deg, #3850b2, #1f2f6d); cursor:pointer }
  .buy:disabled{opacity:.5; cursor:not-allowed}
  .kicker{ font-size:12px; color:var(--good) }
  .warning{ color: var(--warn) }
  .achv{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px dashed #3a4d96; background:#0f1837aa }
  .achv .dot{ width:10px; height:10px; border-radius:50%; background:#3a4d96; }
  .achv.done .dot{ background: var(--good) }
  .footer{
    display:flex; gap:10px; justify-content:space-between; align-items:center; padding:12px 16px; color:var(--muted); font-size:12px;
  }
  .linklike{ text-decoration:underline; cursor:pointer }
  .note{ font-size:12px; color:var(--muted) }
  .statline{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #2b3e82 }
  .statline:last-child{ border-bottom:none }
</style>
</head>
<body>
<canvas id="space"></canvas>
<div class="app">
  <header>
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#6cf3ff"/><stop offset="1" stop-color="#8a7dff"/></linearGradient></defs>
        <path d="M12 2l2.2 4.7L20 7.3l-3.9 3.7.9 5.3-5-2.6-5 2.6.9-5.3L4 7.3l5.8-.6L12 2z" fill="url(#g)"/>
      </svg>
      <div>
        <h1>Astro Tycoon</h1>
      </div>
    </div>
    <div class="totals">
      <div class="pill"><small>Credits</small><span id="credits">0</span></div>
      <div class="pill"><small>pro Sekunde</small><span id="cps">0</span></div>
      <div class="pill"><small>Quantum-Kerne</small><span id="cores">0</span></div>
      <div class="pill"><small>Multiplikator</small><span id="mult">x1.00</span></div>
    </div>
    <div class="controls">
      <button class="btn" id="saveBtn">Speichern</button>
      <button class="btn secondary" id="prestigeBtn" title="Setzt Fortschritt zurück für permanente Boni">Prestige</button>
      <button class="btn secondary" id="resetBtn">Reset</button>
    </div>
  </header>

  <main>
    <section class="sidebar">
      <div class="card">
        <h2>Harvest</h2>
        <div class="panel clicker">
          <div class="rate">Klicke für <b id="clickPowerLabel">+1</b> Credits</div>
          <button class="mega-button" id="harvestBtn">💠 Stardust ernten</button>
          <div class="note">Tipp: Upgrades machen deine Klicks und Gebäude stärker.</div>
        </div>
      </div>

      <div class="card">
        <h2>Stats</h2>
        <div class="panel" id="stats"></div>
      </div>
    </section>

    <section class="card">
      <div class="tabs">
        <div class="tab active" data-tab="buildings">Gebäude</div>
        <div class="tab" data-tab="upgrades">Upgrades</div>
        <div class="tab" data-tab="research">Forschung</div>
        <div class="tab" data-tab="achievements">Erfolge</div>
        <div class="tab" data-tab="settings">Einstellungen</div>
      </div>
      <div class="content" id="tabContent"></div>
      <div class="footer">
        <div>Autosave alle 10s • Offline-Fortschritt aktiv</div>
        <div id="tickInfo">Tick: ok</div>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  "use strict";

  /* ---------- Utilities ---------- */
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const fmt = n => {
    if (!isFinite(n)) return "∞";
    const abs = Math.abs(n);
    if (abs >= 1e15) return (n/1e15).toFixed(2)+" Qa";
    if (abs >= 1e12) return (n/1e12).toFixed(2)+" Tn";
    if (abs >= 1e9) return (n/1e9).toFixed(2)+" B";
    if (abs >= 1e6) return (n/1e6).toFixed(2)+" M";
    if (abs >= 1e3) return (n/1e3).toFixed(2)+" K";
    return n.toFixed(0);
  };
  const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
  const now = () => Date.now();

  /* ---------- Game State ---------- */
  const state = {
    credits: 0,
    totalEarned: 0,
    clickPower: 1,
    coreMultiplier: 1,
    cores: 0,
    lastTick: now(),
    buildings: {
      miner: {name:"Miner", base:1, count:0, cost: 15, scale:1.15, desc:"Erzeugt Stardust passiv."},
      drone: {name:"Drohne", base:5, count:0, cost: 100, scale:1.15, desc:"Selbstständiger Sammler."},
      refinery: {name:"Raffinerie", base:25, count:0, cost: 650, scale:1.16, desc:"Veredelt Stardust für mehr Credits."},
      spaceport: {name:"Spaceport", base:150, count:0, cost: 4200, scale:1.17, desc:"Interstellare Händler docken an."}
    },
    upgrades: {
      click1: {name:"+1 Klickstärke", desc:"Erhöht Klick um +1", cost: 30, bought:false, effect: s=>{s.clickPower+=1}},
      click2: {name:"+5 Klickstärke", desc:"Erhöht Klick um +5", cost: 200, bought:false, req: s=>s.upgrades.click1.bought, effect: s=>{s.clickPower+=5}},
      eff1: {name:"Techniker", desc:"+25% Gebäude-Effizienz", cost: 250, bought:false, effect: s=>{s.coreMultiplier*=1.25}},
      eff2: {name:"Optimierer", desc:"+50% Gebäude-Effizienz", cost: 1200, bought:false, req: s=>s.upgrades.eff1.bought, effect: s=>{s.coreMultiplier*=1.5}},
      turbo: {name:"Auto-Harvester", desc:"+20% CPS & automatisches Klicken", cost: 900, bought:false, effect: s=>{s.autoClick=1}},
    },
    research: {
      overclock: {name:"Overclock", desc:"+100% Produktion für 30s (Cooldown 90s)", cost: 1500, bought:false},
      offline: {name:"Schlaumodus", desc:"x2 Offline-Fortschritt", cost: 1000, bought:false},
      bulk: {name:"Massenkauf", desc:"Kaufe x10 Gebäude", cost: 800, bought:false},
    },
    autoClick: 0,
    overclock: {active:false, until:0, cdUntil:0},
    settings: { notation:"short" },
    achievements: {},
    version: 1
  };

  const STORAGE_KEY = "astro_tycoon_save_v1";

  /* ---------- Rendering ---------- */
  const content = $("#tabContent");
  const tabs = $$(".tab");
  let activeTab = "buildings";

  function render(){
    // header totals
    $("#credits").textContent = fmt(state.credits);
    $("#cps").textContent = fmt(totalCPS());
    $("#cores").textContent = fmt(state.cores);
    $("#mult").textContent = "x" + state.coreMultiplier.toFixed(2);
    $("#clickPowerLabel").textContent = "+" + fmt(state.clickPower + Math.floor(state.autoClick>0? state.clickPower*0.2 : 0));

    // stats
    renderStats();
    // tab
    renderTab(activeTab);
  }

  function renderStats(){
    const s = state;
    const lines = [
      ["Verdient gesamt", fmt(s.totalEarned)],
      ["Klickstärke", fmt(s.clickPower)],
      ["Gebäude gesamt", totalBuildings()],
      ["Prestige-Multiplikator", "x"+s.coreMultiplier.toFixed(2)],
      ["Auto-Klick", s.autoClick? "aktiv":"—"],
      ["Overclock", s.overclock.active? "aktiv":"bereit in "+ Math.max(0, Math.ceil((s.overclock.cdUntil-now())/1000))+"s"],
      ["Version", s.version]
    ];
    const el = $("#stats");
    el.innerHTML = lines.map(([a,b])=>`<div class="statline"><div>${a}</div><div>${b}</div></div>`).join("");
  }

  function renderTab(tab){
    activeTab = tab;
    tabs.forEach(t=> t.classList.toggle("active", t.dataset.tab===tab));
    if (tab==="buildings"){
      content.innerHTML = `
        <div class="grid">
          ${Object.entries(state.buildings).map(([k,b])=>renderBuilding(k,b)).join("")}
        </div>`;
      bindBuildingButtons();
    } else if (tab==="upgrades"){
      content.innerHTML = `
        <div class="grid">
          ${Object.entries(state.upgrades).map(([k,u])=>renderUpgrade(k,u)).join("")}
        </div>`;
      bindUpgradeButtons();
    } else if (tab==="research"){
      content.innerHTML = `
        <div class="grid">
          ${Object.entries(state.research).map(([k,r])=>renderResearch(k,r)).join("")}
        </div>
        <div style="margin-top:8px" class="note">Prestige setzt deinen Fortschritt zurück, gibt aber <b>Quantum-Kerne</b>, die deinen Multiplikator dauerhaft erhöhen.</div>`;
      bindResearchButtons();
    } else if (tab==="achievements"){
      content.innerHTML = renderAchievements();
    } else if (tab==="settings"){
      content.innerHTML = renderSettings();
      bindSettings();
    }
  }

  function renderBuilding(key, b){
    const level = b.count;
    const cps = buildingCPS(key);
    const price = nextCost(b);
    return `
      <div class="item" data-key="${key}">
        <div class="row">
          <h3>${b.name}</h3>
          <div class="level">Lvl ${level}</div>
        </div>
        <div class="desc">${b.desc}</div>
        <div class="row">
          <div class="price">Kosten: ${fmt(price)}</div>
          <button class="buy" data-buy="${key}">Kaufen</button>
        </div>
        <div class="kicker">Ertrag: ${fmt(cps)} / s</div>
      </div>`;
  }

  function renderUpgrade(key, u){
    const owned = !!u.bought;
    let canBuy = !owned && state.credits >= u.cost && (!u.req || u.req(state));
    return `
      <div class="item">
        <div class="row">
          <h3>${u.name}${owned? " ✅":""}</h3>
          <div class="price">${owned? "Gekauft": "Kosten: "+fmt(u.cost)}</div>
        </div>
        <div class="desc">${u.desc}${u.req && !u.bought && !u.req(state) ? ` <span class="warning">(Voraussetzung fehlt)</span>` : ""}</div>
        <div class="row">
          <div></div>
          <button class="buy" ${owned||!canBuy? "disabled": ""} data-upgrade="${key}">${owned? "✓": "Kaufen"}</button>
        </div>
      </div>`;
  }

  function renderResearch(key, r){
    const owned = !!r.bought;
    const canBuy = !owned && state.credits >= r.cost;
    return `
      <div class="item">
        <div class="row">
          <h3>${r.name}${owned? " ✅":""}</h3>
          <div class="price">${owned? "Gekauft": "Kosten: "+fmt(r.cost)}</div>
        </div>
        <div class="desc">${r.desc}</div>
        <div class="row">
          <div></div>
          <button class="buy" ${owned||!canBuy? "disabled": ""} data-research="${key}">${owned? "✓": "Forschen"}</button>
        </div>
      </div>`;
  }

  function renderAchievements(){
    const list = [
      {id:"firstClick", name:"Erster Klick", cond: s=>s.totalEarned>=1},
      {id:"builder", name:"5 Gebäude", cond: s=>totalBuildings()>=5},
      {id:"rich", name:"10.000 Credits", cond: s=>s.totalEarned>=10000},
      {id:"engineer", name:"3 Upgrades", cond: s=>Object.values(s.upgrades).filter(u=>u.bought).length>=3},
      {id:"warp", name:"Erstes Prestige", cond: s=>s.cores>0}
    ];
    for (const a of list){
      state.achievements[a.id] = state.achievements[a.id] || false;
    }
    const html = list.map(a=>{
      const done = a.cond(state);
      state.achievements[a.id] = state.achievements[a.id] || done;
      return `<div class="achv ${done? "done": ""}"><div class="dot"></div><div>${a.name}</div></div>`;
    }).join("");
    return `<div class="panel">${html}</div>`;
  }

  function renderSettings(){
    return `<div class="panel">
      <div class="statline"><div>Notation</div>
        <div>
          <select id="notationSel">
            <option value="short">Kurz (K, M, B)</option>
            <option value="full">Voll</option>
          </select>
        </div>
      </div>
      <div class="statline"><div>Export Save</div><div><span class="linklike" id="exportSave">kopieren</span></div></div>
      <div class="statline"><div>Import Save</div><div><span class="linklike" id="importSave">einfügen</span></div></div>
      <div class="note">Achtung: Reset löscht alles. Prestige gibt dauerhafte Boni.</div>
    </div>`;
  }

  /* ---------- Calculations ---------- */
  function buildingCPS(key){
    const b = state.buildings[key];
    const mult = state.coreMultiplier * (state.overclock.active? 2 : 1);
    return b.base * b.count * mult;
  }
  function totalCPS(){
    let cps = Object.keys(state.buildings).reduce((sum,k)=> sum + buildingCPS(k), 0);
    if (state.autoClick) cps += state.clickPower * 0.2 * state.coreMultiplier * (state.overclock.active? 2 : 1);
    return cps;
  }
  function totalBuildings(){
    return Object.values(state.buildings).reduce((a,b)=>a+b.count,0);
  }
  function nextCost(b){
    return Math.floor(b.cost * Math.pow(b.scale, b.count));
  }
  function prestigeGain(){
    // Square root of total earned / 10k
    return Math.floor(Math.sqrt(state.totalEarned/10000));
  }

  /* ---------- Buying ---------- */
  function buyBuilding(key, qty=1){
    const b = state.buildings[key];
    let bought = 0;
    for (let i=0;i<qty;i++){
      const price = nextCost(b);
      if (state.credits >= price){
        state.credits -= price;
        b.count++;
        bought++;
      } else break;
    }
    if (bought>0) render();
  }
  function buyUpgrade(key){
    const u = state.upgrades[key];
    if (u.bought) return;
    if (u.req && !u.req(state)) return;
    if (state.credits < u.cost) return;
    state.credits -= u.cost;
    u.bought = true;
    u.effect && u.effect(state);
    render();
  }
  function buyResearch(key){
    const r = state.research[key];
    if (r.bought || state.credits < r.cost) return;
    state.credits -= r.cost;
    r.bought = true;
    render();
  }

  /* ---------- Ticking ---------- */
  function addCredits(x){
    if (x<=0) return;
    state.credits += x;
    state.totalEarned += x;
  }

  function gameTick(){
    const t = now();
    const dt = clamp((t - state.lastTick)/1000, 0, 60); // prevent crazy jumps per frame
    state.lastTick = t;

    // production
    addCredits(totalCPS() * dt);

    // autoclick
    if (state.autoClick){
      addCredits(state.clickPower*0.2*dt*state.coreMultiplier * (state.overclock.active? 2 : 1));
    }

    // overclock timers
    if (state.overclock.active && t >= state.overclock.until){
      state.overclock.active = false;
    }

    $("#tickInfo").textContent = `Tick: ${(dt*1000|0)}ms • Prestige möglich: +${fmt(prestigeGain())}`;

    // update some ui smoothly but not too heavy
    $("#credits").textContent = fmt(state.credits);
    $("#cps").textContent = fmt(totalCPS());

    requestAnimationFrame(gameTick);
  }

  /* ---------- Events ---------- */
  $("#harvestBtn").addEventListener("click", () => {
    const gain = state.clickPower * state.coreMultiplier * (state.overclock.active? 2 : 1);
    // little floaty
    spawnFloat(`+${fmt(gain)}`);
    addCredits(gain);
    render();
  });

  function bindTabs(){
    tabs.forEach(t => {
      t.addEventListener("click", () => renderTab(t.dataset.tab));
    });
  }

  function bindBuildingButtons(){
    $$("[data-buy]").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-buy");
        const qty = state.research.bulk?.bought ? 10 : 1;
        buyBuilding(key, qty);
      });
    });
  }
  function bindUpgradeButtons(){
    $$("[data-upgrade]").forEach(btn => {
      btn.addEventListener("click", () => buyUpgrade(btn.getAttribute("data-upgrade")));
    });
  }
  function bindResearchButtons(){
    $$("[data-research]").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-research");
        buyResearch(key);
      });
    });
  }

  $("#saveBtn").addEventListener("click", saveGame);
  $("#resetBtn").addEventListener("click", () => {
    if (confirm("Wirklich ALLES löschen?")) {
      localStorage.removeItem(STORAGE_KEY);
      window.location.reload();
    }
  });
  $("#prestigeBtn").addEventListener("click", () => {
    const gain = prestigeGain();
    if (gain<=0) return alert("Sammle mehr Credits für Prestige!");
    if (confirm(`Prestige? Du bekommst ${gain} Quantum-Kerne und setzt Fortschritt zurück.`)){
      doPrestige(gain);
    }
  });

  function bindSettings(){
    const sel = $("#notationSel");
    if (sel) {
      sel.value = state.settings.notation;
      sel.addEventListener("change", () => {
        state.settings.notation = sel.value;
        render();
      });
    }
    const exp = $("#exportSave");
    exp && exp.addEventListener("click", () => {
      const str = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
      navigator.clipboard.writeText(str).then(()=> alert("Save in Zwischenablage kopiert!"));
    });
    const imp = $("#importSave");
    imp && imp.addEventListener("click", async ()=>{
      const str = prompt("Save-String einfügen:");
      if (!str) return;
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(str))));
        Object.assign(state, obj);
        render();
      }catch(e){
        alert("Ungültiger Save-String.");
      }
    });
  }

  /* ---------- Save/Load/Prestige ---------- */
  function saveGame(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){ console.warn("Save failed", e) }
  }
  function loadGame(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      // shallow merge to keep functions
      for (const k in obj){
        if (typeof obj[k] === "object" && obj[k] && !Array.isArray(obj[k])){
          Object.assign(state[k], obj[k]);
        } else {
          state[k] = obj[k];
        }
      }
    }catch(e){ console.warn("Load failed", e)}
  }

  function doPrestige(gain){
    state.cores += gain;
    state.coreMultiplier *= (1 + gain * 0.1);
    // reset soft progress
    state.credits = 0;
    state.totalEarned = 0;
    state.clickPower = 1;
    for (const b of Object.values(state.buildings)){ b.count = 0; }
    for (const u of Object.values(state.upgrades)){ u.bought = false; }
    for (const r of Object.values(state.research)){ r.bought = false; }
    state.autoClick = 0;
    state.overclock = {active:false, until:0, cdUntil:0};
    render();
    saveGame();
  }

  /* ---------- Offline Progress ---------- */
  function applyOfflineProgress(){
    const last = state.lastTick || now();
    const t = now();
    let dt = Math.max(0, Math.min(60*60*12, (t - last)/1000)); // cap 12h
    const mult = state.research.offline?.bought ? 2 : 1;
    const gain = totalCPS() * dt * mult * 0.5; // 50% efficiency offline
    if (gain>0){
      addCredits(gain);
    }
    state.lastTick = t;
  }

  /* ---------- Visuals ---------- */
  function spawnFloat(text){
    const btn = $("#harvestBtn");
    const rect = btn.getBoundingClientRect();
    const el = document.createElement("div");
    el.textContent = text;
    el.style.position="fixed";
    el.style.left = (rect.left + rect.width/2 - 10 + (Math.random()*60-30))+"px";
    el.style.top = (rect.top + 4)+"px";
    el.style.fontWeight="900";
    el.style.pointerEvents="none";
    el.style.textShadow="0 2px 12px rgba(0,0,0,.6)";
    el.style.transition="all .9s ease";
    el.style.opacity="1";
    el.style.transform="translateY(0)";
    document.body.appendChild(el);
    requestAnimationFrame(()=>{
      el.style.opacity="0";
      el.style.transform="translateY(-40px) scale(1.1)";
    });
    setTimeout(()=> el.remove(), 1000);
  }

  // starfield
  function starfield(){
    const c = $("#space");
    const ctx = c.getContext("2d");
    let w= c.width= innerWidth, h= c.height= innerHeight;
    let stars = Array.from({length: 160}, () => ({
      x: Math.random()*w, y: Math.random()*h, z: Math.random()*1+0.2, r: Math.random()*1.2+0.2
    }));
    function draw(){
      ctx.clearRect(0,0,w,h);
      for (const s of stars){
        s.x += s.z;
        if (s.x > w) s.x = 0;
        ctx.globalAlpha = 0.6*s.z;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = "#cde7ff";
        ctx.fill();
      }
      requestAnimationFrame(draw);
    }
    window.addEventListener("resize", ()=>{ w=c.width=innerWidth; h=c.height=innerHeight });
    draw();
  }

  /* ---------- Overclock action ---------- */
  function tryOverclock(){
    const t = now();
    if (!state.research.overclock?.bought) return alert("Erforsche 'Overclock' zuerst!");
    if (state.overclock.active) return;
    if (t < state.overclock.cdUntil) return alert("Overclock noch im Cooldown.");
    state.overclock.active = true;
    state.overclock.until = t + 30_000;
    state.overclock.cdUntil = t + 90_000;
  }

  /* ---------- Init ---------- */
  function init(){
    loadGame();
    applyOfflineProgress();
    bindTabs();
    render();
    starfield();
    requestAnimationFrame(gameTick);
    // autosave
    setInterval(saveGame, 10_000);

    // keyboard: space = harvest, o = overclock
    window.addEventListener("keydown", (e)=>{
      if (e.code === "Space"){ e.preventDefault(); $("#harvestBtn").click(); }
      if (e.key.toLowerCase() === "o"){ tryOverclock(); }
    });

    // Tooltip info on Prestige button
    $("#prestigeBtn").title = "Prestige setzt Fortschritt zurück und gibt Quantum-Kerne. Aktuell: +"+prestigeGain();
  }

  init();
})();
</script>
</body>
</html>
